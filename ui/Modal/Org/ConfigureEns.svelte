<!--
 Copyright Â© 2021 The Radicle Upstream Contributors

 This file is part of radicle-upstream, distributed under the GPLv3
 with Radicle Linking Exception. For full terms see the included
 LICENSE file.
-->
<script lang="typescript">
  import type * as ethers from "ethers";

  import * as ensResolver from "ui/src/org/ensResolver";
  import * as modal from "ui/src/modal";
  import * as error from "ui/src/error";
  import { unreachable } from "ui/src/unreachable";

  import ConfigureEnsIntro from "./ConfigureEns/ConfigureEnsIntro.svelte";
  import EnterEnsName from "./ConfigureEns/EnterEnsName.svelte";
  import LinkOrgToName from "./ConfigureEns/LinkOrgToName.svelte";
  import UpdateMetadata from "./ConfigureEns/UpdateMetadata.svelte";

  export let orgAddress: string;
  export let registration: ensResolver.Registration | undefined = undefined;
  export let safeAddress: string | undefined = undefined;
  export let fee: ethers.BigNumber;

  type State =
    | { type: "intro" }
    | { type: "enterEnsName"; name: string }
    | {
        type: "updateMetadata";
        registration: ensResolver.Registration;
      }
    | {
        type: "linkOrgToName";
        domain: string;
      };

  let state: State = ((): State => {
    if (registration) {
      const existingName = registration.domain.replace(
        `.${ensResolver.DOMAIN}`,
        ""
      );
      return { type: "enterEnsName", name: existingName };
    } else {
      return { type: "intro" };
    }
  })();

  function bindRegistrationDone(name: string) {
    const domain = `${name}.${ensResolver.DOMAIN}`;
    return async function () {
      // TODO handle exception
      const registration = await ensResolver.getRegistration(domain);
      if (!registration) {
        throw new error.Error({
          message: "Domain not registered",
          details: { domain },
        });
      }
      state = {
        type: "updateMetadata",
        registration,
      };
    };
  }

  function configureEnsIntroDone() {
    const existingName = registration?.domain.replace(
      `.${ensResolver.DOMAIN}`,
      ""
    );

    state = {
      type: "enterEnsName",
      name: existingName || "",
    };
  }

  function bindPopulateMetadataDone(domain: string) {
    return () => {
      state = {
        type: "linkOrgToName",
        domain,
      };
    };
  }

  function linkOrgToNameDone() {
    modal.hide();
  }
</script>

{#if state.type === "intro"}
  <ConfigureEnsIntro onSubmit={configureEnsIntroDone} {fee} />
{:else if state.type === "enterEnsName"}
  <EnterEnsName
    name={state.name}
    {fee}
    done={bindRegistrationDone(state.name)} />
{:else if state.type === "updateMetadata"}
  <UpdateMetadata
    {orgAddress}
    registration={state.registration}
    onSubmit={bindPopulateMetadataDone(state.registration.domain)} />
{:else if state.type === "linkOrgToName"}
  <LinkOrgToName
    domain={state.domain}
    {orgAddress}
    {safeAddress}
    onSubmit={linkOrgToNameDone} />
{:else}
  {unreachable(state)}
{/if}
